<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Audiobooks | CourseCove</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="css/style.css" />
<link rel="icon" type="image/png" href="images/favicon.png" />
<style>
  body { font-family: 'Inter', sans-serif; background-color: #f4f7fb; margin:0; padding: 1.5rem;}
  header { text-align:center; margin:20px 0; }
  header h1 { font-size:2.5rem; color:#333; margin:0; }
  header p { font-size:1.125rem; color:#666; }
  .filters { display:flex; justify-content:center; margin:20px 0; gap:20px; flex-wrap:wrap; }
  select, input[type="text"] { padding:10px; border-radius:8px; border:1px solid #ddd; font-size:1rem; width:200px; }
  #loading { text-align:center; margin:20px; color:#666; }
  .card-body { display: flex; flex-direction: column; justify-content: space-between; }
  .card-title { font-size: 1.125rem; font-weight: bold; }
  .card-text { font-size: 0.875rem; color: #555; }
  .btn { margin-top: auto; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg" style="background-color: #e3e5e9;">
  <div class="container">
    <a class="navbar-brand" href="../index.html">
      <img src="images/logo1.png" alt="Course Aggregator Logo" style="height: 70px; width: auto;" />
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon" style="filter: invert(1);"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="math.html">Math</a></li>
        <li class="nav-item"><a class="nav-link" href="ai-ml.html">AI / ML</a></li>
        <li class="nav-item"><a class="nav-link" href="arts-humanities.html">Arts & Humanities</a></li>
        <li class="nav-item"><a class="nav-link" href="languages.html">Languages</a></li>
        <li class="nav-item"><a class="nav-link" href="politics-economics.html">Politics & Economics</a></li>
        <li class="nav-item"><a class="nav-link" href="environment.html">Environment</a></li>
        <li class="nav-item"><a class="nav-link" href="../blog.html">Blog</a></li>
        <li class="nav-item"><a class="nav-link" href="books.html">Books</a></li>
        <li class="nav-item"><a class="nav-link active" href="#">Audiobooks</a></li>
        <li class="nav-item"><a class="nav-link" href="articles.html">Articles</a></li>
        <li class="nav-item"><a class="nav-link" href="citation.html">Citation generator</a></li>                
        <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
      </ul>
    </div>
  </div>
</nav>

<header>
  <h1>Audiobooks</h1>
  <p>Discover public-domain audiobooks from LibriVox and Internet Archive.</p>
</header>

<div class="filters">
  <input type="text" id="searchBar" placeholder="Search audiobooks..." />
  <select id="categoryFilter">
    <option value="">All Categories</option>
    <option value="Literature">Literature</option>
    <option value="History">History</option>
    <option value="Science">Science</option>
    <option value="Philosophy">Philosophy</option>
    <option value="Politics">Politics</option>
    <option value="Economics">Economics</option>
  </select>
</div>

<div class="container my-4">
  <div class="row" id="audiobook-container"></div>
</div>

<div id="loading">Loading audiobooks...</div>

<footer class="bg-dark text-white py-4 mt-5">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center">
    <div class="mb-2 mb-md-0">
      <strong>Course Aggregator</strong> &nbsp;|&nbsp;
      <strong>Â© 2025 All rights reserved.</strong>
    </div>
    <div>
      <a href="../index.html" class="text-light text-decoration-none me-3">Home</a>
      <a href="contact.html" class="text-light text-decoration-none me-3">Contact</a>
      <a href="privacy.html" class="text-light text-decoration-none">Privacy</a>
    </div>
  </div>
</footer>

<script>
const container = document.getElementById('audiobook-container');
const searchBar = document.getElementById('searchBar');
const categoryFilter = document.getElementById('categoryFilter');
const loadingEl = document.getElementById('loading');

let allItems = [];
let isFetching = false;
let offsets = { lv: 0, ia: 0 };
const limit = 12;

// Category mapping
function normalizeCategory(title, sourceCategory = '') {
  const t = title.toLowerCase();
  const sc = sourceCategory.toLowerCase();
  if(t.includes('politics') || sc.includes('politics') || sc.includes('government')) return 'Politics';
  if(t.includes('economics') || t.includes('money') || sc.includes('economics') || sc.includes('finance')) return 'Economics';
  if(t.includes('philosophy') || sc.includes('philosophy') || sc.includes('religion') || t.includes('meditation')) return 'Philosophy';
  if(t.includes('science') || t.includes('physics') || t.includes('biology') || sc.includes('science') || sc.includes('technology')) return 'Science';
  if(t.includes('history') || t.includes('war') || sc.includes('history') || sc.includes('biography')) return 'History';
  return 'Literature';
}

// Render items
function renderItems(items) {
  container.innerHTML = '';
  if(items.length === 0){
    container.innerHTML = '<div class="col-12 text-center text-muted">No results found.</div>';
    return;
  }
  items.forEach(item => {
    const col = document.createElement('div');
    col.className = 'col-12 col-md-4 col-lg-3 mb-4';
    col.innerHTML = `
      <div class="card h-100 shadow-sm">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">${item.title}</h5>
          <p class="card-text mb-1">Author: ${item.authors}</p>
          <p class="text-muted small">Category: ${item.category}</p>
          <a href="${item.link}" target="_blank" class="mt-auto btn btn-primary btn-sm">Listen / Download</a>
        </div>
      </div>`;
    container.appendChild(col);
  });
}

// Fetch LibriVox via allorigins to bypass CORS
async function fetchLibriVox(offset=0, query='') {
  try {
    let url = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://librivox.org/api/feed/audiobooks?format=json&limit=${limit}&offset=${offset}`)}`;
    if(query) url = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://librivox.org/api/feed/audiobooks?format=json&limit=${limit}&title=${encodeURIComponent(query)}&offset=${offset}`)}`;
    const res = await fetch(url);
    const data = await res.json();
    const books = JSON.parse(data.contents).books || [];
    return books.map(b => ({
      title: b.title || 'Unknown',
      authors: Array.isArray(b.authors) && b.authors.length
                 ? b.authors.map(a => (a.first_name||'')+' '+(a.last_name||'')).join(', ')
                 : 'Unknown',
      link: b.url_librivox || '#',
      category: normalizeCategory(b.title)
    }));
  } catch(err) {
    console.error('LibriVox fetch error:', err);
    return [];
  }
}

// Fetch Internet Archive audiobooks
async function fetchInternetArchive(offset=0, query='') {
  try {
    const page = offset / limit + 1;
    let q = 'mediatype:audiobook';
    if(query) q += ` AND ${query}`;
    const url = `https://archive.org/advancedsearch.php?q=${encodeURIComponent(q)}&rows=${limit}&page=${page}&output=json`;
    const res = await fetch(url);
    const data = await res.json();
    return data.response.docs.map(d => ({
      title: d.title || 'Unknown',
      authors: d.creator || 'Unknown',
      link: d.identifier ? `https://archive.org/details/${d.identifier}` : '#',
      category: normalizeCategory(d.title, d.subject ? d.subject.join(' ') : '')
    }));
  } catch(err) {
    console.error('Internet Archive fetch error:', err);
    return [];
  }
}

// Load audiobooks with throttling
async function loadAudiobooks(query='') {
  if(isFetching) return;
  isFetching = true;
  loadingEl.style.display = 'block';

  try {
    const [lv, ia] = await Promise.all([
      fetchLibriVox(offsets.lv, query),
      fetchInternetArchive(offsets.ia, query)
    ]);

    offsets.lv += limit;
    offsets.ia += limit;

    const newItems = [...lv, ...ia];
    const uniqueItems = newItems.filter(n => !allItems.some(a => a.link === n.link));
    allItems.push(...uniqueItems);
  } catch(err) {
    console.error('Error loading audiobooks:', err);
  }

  isFetching = false;
  loadingEl.style.display = 'none';
  renderFilteredItems();
}

// Render filtered items based on current search & category
function renderFilteredItems() {
  const searchTerm = searchBar.value.trim().toLowerCase();
  const category = categoryFilter.value.trim().toLowerCase();

  const filtered = allItems.filter(item =>
    (!searchTerm || item.title.toLowerCase().includes(searchTerm)) &&
    (!category || item.category.toLowerCase() === category)
  );

  // Fetch more if nothing matches locally
  if(filtered.length === 0 && !isFetching && (searchTerm || category)) {
    loadAudiobooks(searchTerm || category);
    return;
  }

  renderItems(filtered);
}

// Infinite scroll
window.addEventListener('scroll', () => {
  if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
    loadAudiobooks();
  }
});

// Event listeners
searchBar.addEventListener('input', () => renderFilteredItems());
categoryFilter.addEventListener('change', () => renderFilteredItems());

// Initial load
loadAudiobooks();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
